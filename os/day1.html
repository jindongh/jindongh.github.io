<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
</head>
<body>
<div class="header">
    <div class="home left">
        <a href="/" title="Home">Home</a>
    </div>
    <div class="nav right">
        <a href="/algo">Algorithm</a>
        <a href="/proj">Project</a>
        <a href="/util">Utilities</a>
        <a href="/code">Code</a>
        <a href="/book">Book</a>
        <a href="/android">Android</a>
        <a href="/about">About</a>
    </div>
</div>

<div class="content">
    <h1>Day 1: Qemu and Hello World</h1>
    <div>
        <h2>开发环境</h2>
        <p>工欲善其事，必先利其器。第一天配置开发环境qemu，并运行hello world</p>
    </div>
    <div>
        <h2>安装qemu和nasm</h2>
        <p>QEMU是一个跨平台的仿真软件,nasm是一个跨平台的汇编编译器</p>
        <p>Mac下可以用brew安装Qemu和nasm</p>
        <pre class="prettyprint linenums">
brew install qemu
brew install nasm
        </pre>
    </div>
    <div>
        <h2>第一版hellov1.asm</h2>
<pre class="prettyprint linenums">
DB 0xeb, 0x4e, 0x90, 0x48, 0x45, 0x4c, 0x4c, 0x4f
DB 0x49, 0x50, 0x4c, 0x00, 0x02, 0x01, 0x01, 0x00
DB 0x02, 0xe0, 0x00, 0x40, 0x0b, 0xf0, 0x09, 0x00
DB 0x12, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00
DB 0x40, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x29, 0xff
DB 0xff, 0xff, 0xff, 0x48, 0x45, 0x4c, 0x4c, 0x4f
DB 0x2d, 0x4f, 0x53, 0x20, 0x20, 0x20, 0x46, 0x41
DB 0x54, 0x31, 0x32, 0x20, 0x20, 0x20, 0x00, 0x00
RESB 16
DB 0xb8, 0x00, 0x00, 0x8e, 0xd0, 0xbc, 0x00, 0x7c
DB 0x8e, 0xd8, 0x8e, 0xc0, 0xbe, 0x74, 0x7c, 0x8a
DB 0x04, 0x83, 0xc6, 0x01, 0x3c, 0x00, 0x74, 0x09
DB 0xb4, 0x0e, 0xbb, 0x0f, 0x00, 0xcd, 0x10, 0xeb
DB 0xee, 0xf4, 0xeb, 0xfd, 0x0a, 0x0a, 0x68, 0x65
DB 0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72
DB 0x6c, 0x64, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00
RESB 368
DB 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x55, 0xaa
DB 0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
RESB 4600
DB 0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
RESB 1469432
        </pre>
        <p>编译运行</p>
<pre class="prettyprint linenums">
nasm hellov1.asm -o hellov1.img
qemu-system-x86_64 hellov1.img
        </pre>
        <p>运行结果</p>
        <img src="/image/os/day1-1.png"/>
    </div>
    <div>
        <h2>第二版hellov2.asm</h2>
<pre class="prettyprint linenums">
; hello-os
; TAB=4
; 以下这段是标准FAT12格式软盘专用的代码
 DB 0xeb, 0x4e, 0x90
 DB "HELLOIPL" ; 启动区的名称可以是任意的字符串（8字节）
 DW 512 ; 每个扇区（sector）的大小（必须为512字节）
 DB 1 ; 簇（cluster）的大小（必须为1个扇区）
 DW 1 ; FAT的起始位置（一般从第一个扇区开始）
 DB 2 ; FAT的个数（必须为2）
 DW 224 ; 根目录的大小（一般设成224项）
 DW 2880 ; 该磁盘的大小（必须是2880扇区）
 DB 0xf0 ; 磁盘的种类（必须是0xf0）
 DW 9 ; FAT的长度（必须是9扇区）
 DW 18 ; 1个磁道（track）有几个扇区（必须是18）
 DW 2 ; 磁头数（必须是2）
 DD 0 ; 不使用分区，必须是0
 DD 2880 ; 重写一次磁盘大小
 DB 0,0,0x29 ; 意义不明，固定
 DD 0xffffffff ;（可能是）卷标号码
 DB "HELLO-OS   " ; 磁盘的名称（11字节）
 DB "FAT12   " ; 磁盘格式名称（8字节）
 RESB 18 ; 先空出18字节
; 程序主体
 DB 0xb8, 0x00, 0x00, 0x8e, 0xd0, 0xbc, 0x00, 0x7c
 DB 0x8e, 0xd8, 0x8e, 0xc0, 0xbe, 0x74, 0x7c, 0x8a
 DB 0x04, 0x83, 0xc6, 0x01, 0x3c, 0x00, 0x74, 0x09
 DB 0xb4, 0x0e, 0xbb, 0x0f, 0x00, 0xcd, 0x10, 0xeb
 DB 0xee, 0xf4, 0xeb, 0xfd
; 信息显示部分
 DB 0x0a, 0x0a ; 2个换行
 DB "hello, world v2"
 DB 0x0a ; 换行
 DB 0
 RESB 0x1fe-($-$$) ; 填写0x00,直到 0x001fe
 DB 0x55, 0xaa
; 以下是启动区以外部分的输出
 DB 0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
 RESB 4600
 DB 0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
 RESB 1469432
        </pre>
        <p>注意:<p>
        <p>1. 如果编译出错，原因是nasm语法的问题，解决办法是将0x1fe-$替换成0x1fe-($-$$):
        hellov2.asm:34: error: attempt to reserve non-constant quantity of BSS space</p>
        <p>2. 如果从pdf拷贝的代码，运行时没有输出，原因是拷贝的时候第20和21行的三个空格变成了一个</p>
        <p>编译运行</p>
<pre class="prettyprint linenums">
nasm hellov2.asm -o hellov2.img
qemu-system-x86_64 hellov2.img
        </pre>
        <p>运行结果</p>
        <img src="/image/os/day1-2.png"/>
    </div>
</div>

<link type="text/css" href="/css/default.css" rel="stylesheet" />
<link type="text/css" href="/css/prettify.css" rel="stylesheet" />
<script type="text/javascript" src="/js/prettify.js"></script>
<script type="text/javascript" src="/js/default.js"></script>
</body>
</html>
